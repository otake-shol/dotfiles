name: Benchmark

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  zsh-startup:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install zsh (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh hyperfine

      - name: Install hyperfine (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install hyperfine

      - name: Setup minimal zsh environment
        run: |
          # Create minimal .zshrc for benchmark
          cat > ~/.zshrc.benchmark << 'EOF'
          # Minimal zshrc for benchmark
          export DOTFILES_PROFILE=minimal
          [[ -f ~/dotfiles/.zshrc ]] && source ~/dotfiles/.zshrc
          EOF

          # Link dotfiles
          ln -sf "$PWD" ~/dotfiles

      - name: Benchmark zsh startup time
        id: benchmark
        run: |
          echo "## Zsh Startup Benchmark" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "OS: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Warm up
          for i in {1..3}; do
            zsh -i -c exit 2>/dev/null || true
          done

          # Benchmark with hyperfine
          echo '```' >> $GITHUB_STEP_SUMMARY
          hyperfine \
            --warmup 3 \
            --runs 10 \
            --shell=none \
            'zsh -i -c exit' \
            2>&1 | tee -a $GITHUB_STEP_SUMMARY || \
            echo "Benchmark failed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Extract mean time for comparison
          MEAN_TIME=$(hyperfine --warmup 3 --runs 5 --shell=none \
            'zsh -i -c exit' --export-json /tmp/bench.json 2>/dev/null && \
            jq -r '.results[0].mean' /tmp/bench.json || echo "N/A")
          echo "mean_time=$MEAN_TIME" >> $GITHUB_OUTPUT

      - name: Check startup time threshold
        run: |
          # Warn if startup time exceeds 1 second
          MEAN_TIME="${{ steps.benchmark.outputs.mean_time }}"
          if [[ "$MEAN_TIME" != "N/A" ]]; then
            THRESHOLD=1.0
            CMP=$(echo "$MEAN_TIME > $THRESHOLD" | bc -l 2>/dev/null || echo 0)
            if (( CMP )); then
              echo "::warning::Startup $MEAN_TIME s > $THRESHOLD s"
            else
              echo "Startup time ($MEAN_TIME s) OK"
            fi
          fi

  comment-on-pr:
    needs: zsh-startup
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Comment benchmark results
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Benchmark Results')
            );

            const runUrl = `${context.serverUrl}/${context.repo.owner}/` +
              `${context.repo.repo}/actions/runs/${context.runId}`;
            const body = `## Benchmark Results

            Zsh startup benchmark completed. See [run](${runUrl}).

            > Note: Startup time should be under 0.5s for optimal experience.
            `;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
