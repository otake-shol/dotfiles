name: Nix

on:
  push:
    branches: [master, main]
    paths:
      - '*.nix'
      - 'nix/**'
      - 'flake.lock'
  pull_request:
    branches: [master, main]
    paths:
      - '*.nix'
      - 'nix/**'
      - 'flake.lock'

jobs:
  check:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check flake
        run: |
          nix flake check --no-build

      - name: Show flake info
        run: |
          nix flake show

      - name: Build devShell (Linux)
        if: runner.os == 'Linux'
        run: |
          nix build .#devShells.x86_64-linux.default --dry-run

      - name: Build devShell (macOS)
        if: runner.os == 'macOS'
        run: |
          ARCH=$(uname -m)
          if [[ "$ARCH" == "arm64" ]]; then
            nix build .#devShells.aarch64-darwin.default --dry-run
          else
            nix build .#devShells.x86_64-darwin.default --dry-run
          fi

  format:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Check Nix formatting
        run: |
          nix run nixpkgs#nixfmt-rfc-style -- --check *.nix nix/*.nix || {
            echo "::warning::Nix files not formatted. Run nixfmt to fix."
            exit 0
          }

  update-lock:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Update flake.lock
        id: update
        run: |
          nix flake update
          if git diff --quiet flake.lock; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore(nix): update flake.lock'
          title: 'chore(nix): update flake.lock'
          body: |
            Automated flake.lock update.

            Updates the Nix flake lock file with the latest inputs.
          branch: chore/update-flake-lock
          delete-branch: true
