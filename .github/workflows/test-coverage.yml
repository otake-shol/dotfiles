name: Test Coverage

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bats kcov

      - name: Install bats helpers
        run: |
          sudo mkdir -p /usr/local/lib/bats-support /usr/local/lib/bats-assert
          BATS_SUPPORT="https://github.com/bats-core/bats-support.git"
          BATS_ASSERT="https://github.com/bats-core/bats-assert.git"
          git clone --depth 1 "$BATS_SUPPORT" /tmp/bats-support
          git clone --depth 1 "$BATS_ASSERT" /tmp/bats-assert
          sudo cp -r /tmp/bats-support/* /usr/local/lib/bats-support/
          sudo cp -r /tmp/bats-assert/* /usr/local/lib/bats-assert/

      - name: Run tests with coverage
        run: |
          mkdir -p coverage
          # Run bats tests
          bats tests/*.bats --formatter tap > coverage/bats-results.tap || true

          # Generate coverage for shell scripts using kcov
          SCRIPTS="scripts/lib/*.sh scripts/maintenance/*.sh scripts/utils/*.sh"
          for script in $SCRIPTS; do
            if [[ -f "$script" ]]; then
              name=$(basename "$script" .sh)
              kcov --include-path=scripts "coverage/kcov-$name" \
                bash -n "$script" 2>/dev/null || true
            fi
          done

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: ./coverage
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: coverage/
          retention-days: 7

  bats-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bats (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y bats
          sudo mkdir -p /usr/local/lib/bats-support /usr/local/lib/bats-assert
          git clone --depth 1 \
            https://github.com/bats-core/bats-support.git /tmp/bats-support
          git clone --depth 1 \
            https://github.com/bats-core/bats-assert.git /tmp/bats-assert
          sudo cp -r /tmp/bats-support/* /usr/local/lib/bats-support/
          sudo cp -r /tmp/bats-assert/* /usr/local/lib/bats-assert/

      - name: Install bats (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install bats-core
          brew tap bats-core/bats-core
          brew install bats-support bats-assert
          sudo mkdir -p /usr/local/lib
          PREFIX=$(brew --prefix)
          sudo ln -sf "$PREFIX/lib/bats-support" /usr/local/lib/bats-support
          sudo ln -sf "$PREFIX/lib/bats-assert" /usr/local/lib/bats-assert

      - name: Run bats tests
        run: |
          bats tests/*.bats --formatter pretty

      - name: Test common.sh directly
        run: |
          bash scripts/lib/common.sh || true
